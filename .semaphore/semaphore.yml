version: v1.0
name: Rewriting pipeline from meta.yml
agent:
  machine:
    type: e1-standard-2

  containers:
    - name: main
      # todo: put latest base image tag as env variable: LATEST_BASE_IMAGE_TAG
      image: dusanov/se-base-image:latest  # $LATEST_BASE_IMAGE_TAG

auto_cancel:
  running:
    when: "true"

blocks:
  # not sure if this is needed
  # since there is a prologue in block "build dependencies"
  - name: Setup
    dependencies: []
    task:
      jobs:
        - name: cache_restore
          commands:
            - checkout
            - cache restore

  - name: "build dependencies"
    dependencies: []
    task:
      prologue:
        commands:
          - checkout
          - cache restore
      jobs:
        - name: ruby deps
          commands:
            - bundle install --path vendor/bundle
            - cache store
        - name: node deps
          commands:
            - npm install
            - cache store

  - name: ruby tests
    dependencies: ["build dependencies"]
    jobs:
      - name: unit tests
        commands:
          - echo "running ruby unit tests"
          - sleep 2
      - name: integration tests
        commands:
          - echo "running ruby integration tests"
          - sleep 5

  - name: "nodejs tests"
    dependencies: ["build dependencies"]
    commands:
      - echo "running nodejs tests"
      - sleep 3

  - name: build website
    dependencies: ["nodejs tests"]
    commands:
      - cache restore  # nodejs
      - mkdir website
      - echo "<h1>Hello</h1>" >> website/index.html
      # store website/ directory as artifact
      - artifact push workflow website

promotions:
  - name: Upload website
    pipeline_file: deploy-website.yml
    auto_promote_on:
      - result: passed
