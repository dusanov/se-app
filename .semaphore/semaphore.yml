version: v1.0
name: Rewriting pipeline from meta.yml
agent:
  machine:
    type: e1-standard-2

  containers:
    - name: main
      image: dusanov/se-base-image:latest  # $LATEST_BASE_IMAGE_TAG

blocks:
  - name: Setup
    dependencies: []
    task:
      jobs:
        - name: cache_restore
          commands:
            - checkout
            - cache restore

  - name: "build dependencies"
    dependencies: []
    task:
      prologue:
        commands:
          - checkout
          - cache restore
      epilogue:
        commands:
          - cache store

      jobs:
        - name: ruby deps
          commands:
            - bundle install --path vendor/bundle
        - name: node deps
          commands:
            - npm install

  - name: "ruby tests"
    dependencies: ["build dependencies"]
    task:
      jobs:
        - name: unit tests
          commands:
            - echo "running ruby unit tests"
            - sleep 2
        - name: integration tests
          commands:
            - echo "running ruby integration tests"
            - sleep 5
